{"version":3,"file":"MessageReader.js","names":["_facade","require","_envInfo","asyncGeneratorStep","n","t","e","r","o","a","c","i","u","value","done","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","_defineProperty","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","_toPrimitive","Symbol","toPrimitive","call","TypeError","String","Number","parseJsonResult","data","JSON","parse","Buffer","from","toString","MessageReader","constructor","_this","tests","groups","attachments","globals","jsonMessage","_this$results$globals","path","type","results","push","envInfo","parseEnvInfo","categories","handleCustomMessage","step","attachment","stringify","stringifyEnvInfo","key","keys","content","contentType","encoding","tr","concat","uuid","trc","exports"],"sources":["../../../../../src/sdk/reporter/writer/MessageReader.ts"],"sourcesContent":["import { attachment, step } from \"../../../facade.js\";\nimport type { TestResult, TestResultContainer } from \"../../../model.js\";\nimport type { AllureResults } from \"../../types.js\";\nimport { parseEnvInfo, stringifyEnvInfo } from \"../utils/envInfo.js\";\n\nconst parseJsonResult = <T>(data: string) => {\n  return JSON.parse(Buffer.from(data, \"base64\").toString(\"utf-8\")) as T;\n};\n\nexport class MessageReader {\n  readonly results: AllureResults = {\n    tests: [],\n    groups: [],\n    attachments: {},\n    globals: {},\n  };\n\n  handleMessage = (jsonMessage: string) => {\n    const { path, type = \"undefined\", data }: { path: string; type?: string; data: string } = JSON.parse(jsonMessage);\n\n    switch (type) {\n      case \"container\":\n        this.results.groups.push(parseJsonResult<TestResultContainer>(data));\n        return;\n      case \"result\":\n        this.results.tests.push(parseJsonResult<TestResult>(data));\n        return;\n      case \"attachment\":\n        this.results.attachments[path] = data;\n        return;\n      case \"globals\":\n        this.results.globals = this.results.globals ?? {};\n        this.results.globals[path] = parseJsonResult(data);\n        return;\n      case \"misc\":\n        switch (path) {\n          case \"environment.properties\":\n            this.results.envInfo = parseEnvInfo(Buffer.from(data, \"base64\").toString());\n            break;\n          case \"categories.json\":\n            this.results.categories = parseJsonResult(data);\n            break;\n          default:\n            break;\n        }\n        return;\n      default:\n        this.handleCustomMessage(type, data, path);\n        return;\n    }\n  };\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  handleCustomMessage = (type: string, data: any, path: string) => {};\n\n  attachResults = async () => {\n    await step(\"allure-results\", async () => {\n      if (this.results.categories) {\n        await attachment(\"categories.json\", JSON.stringify(this.results.categories), \"application/json\");\n      }\n      if (this.results.envInfo) {\n        await attachment(\"environment.properties\", stringifyEnvInfo(this.results.envInfo), \"text/plain\");\n      }\n      if (this.results.attachments) {\n        for (const key of Object.keys(this.results.attachments)) {\n          const content = this.results.attachments[key];\n          await attachment(key, content, {\n            contentType: \"text/plain\",\n            encoding: \"base64\",\n          });\n        }\n      }\n      if (this.results.tests) {\n        for (const tr of this.results.tests) {\n          await attachment(`${tr.uuid}-result.json`, JSON.stringify(tr, null, 2), {\n            contentType: \"application/json\",\n            encoding: \"utf-8\",\n          });\n        }\n      }\n      if (this.results.groups) {\n        for (const trc of this.results.groups) {\n          await attachment(`${trc.uuid}-container.json`, JSON.stringify(trc, null, 2), {\n            contentType: \"application/json\",\n            encoding: \"utf-8\",\n          });\n        }\n      }\n      if (this.results.globals) {\n        for (const key of Object.keys(this.results.globals)) {\n          await attachment(key, JSON.stringify(this.results.globals[key], null, 2), {\n            contentType: \"application/json\",\n            encoding: \"utf-8\",\n          });\n        }\n      }\n    });\n  };\n}\n"],"mappings":"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","ignoreList":[]}